SELECT

NULLIF(SUM(TOTNOTA-BONIFICACAO),0) AS VLRVENDAS,mes,nat
FROM
(
SELECT DISTINCT

CASE WHEN T.BONIFICACAO = 'S' THEN (SELECT ISNULL(SUM(I.VLRTOT - I.VLRDESC),0) FROM sankhya.TGFITE I WHERE I.NUNOTA = CAB.NUNOTA) ELSE 0 END AS BONIFICACAO,
CASE WHEN T.BONIFICACAO = 'S' THEN 'BR' ELSE 'VR' END AS NAT,
(SELECT NULLIF(SUM(I.VLRTOT - I.VLRDESC),0) FROM sankhya.TGFITE I WHERE I.NUNOTA = CAB.NUNOTA) AS TOTNOTA,
month(cab.dtneg) mes

FROM  sankhya.TGFCAB CAB (NOLOCK)
 JOIN sankhya.TGFPAR PAR ON PAR.CODPARC = CAB.CODPARC
 JOIN sankhya.TGFVEN VEN ON VEN.CODVEND = CAB.CODVEND
 JOIN sankhya.TSIREG REG ON REG.CODREG = PAR.CODREG
 JOIN sankhya.TSIEMP EMP ON EMP.CODEMP = CAB.CODEMP
 JOIN sankhya.TGFTOP T ON T.CODTIPOPER = CAB.CODTIPOPER
 JOIN sankhya.TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
 JOIN sankhya.TGFPRO PROD ON PROD.CODPROD = ITE.CODPROD
WHERE CAB.TIPMOV = 'P'

AND CAB.CODVEND <> 0
AND  CAB.CODTIPOPER in ('900','901','902','903','904','906','1253')
AND PAR.CODPARC <>'1378'  AND PROD.CODPROD NOT BETWEEN  64000 AND 64006
AND PROD.CODPROD NOT BETWEEN 84550 AND 84602
and cab.dtneg BETWEEN convert(date,'01.01.2022',103) AND convert(date,'31.12.2022',103) 

AND PROD.CODPROD NOT BETWEEN 64000 and 64006
) BASE

GROUP BY
 
 NAT,mes